<div class="container mt-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">Gestión de Usuarios</h5>
      <button 
        class="btn btn-primary btn-sm" 
        (click)="mostrarFormularioCrear()"
        [disabled]="cargando">
        + Nuevo Usuario
      </button>
    </div>
    
    <div class="card-body">
      <!-- Formulario -->
      <div class="row mb-4" *ngIf="mostrarFormulario">
        <div class="col-12">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0">{{ editando ? 'Editar Usuario' : 'Nuevo Usuario' }}</h6>
            </div>
            <div class="card-body">
              <form [formGroup]="usuarioForm" (ngSubmit)="guardarUsuario()">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="nombre" class="form-label">Nombre *</label>
                    <input 
                      type="text" 
                      class="form-control"
                      [class.is-invalid]="campoEsInvalido('nombre')"
                      id="nombre"
                      formControlName="nombre"
                      placeholder="Ingrese el nombre completo">
                    <div class="invalid-feedback">
                      {{ obtenerMensajeError('nombre') }}
                    </div>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="email" class="form-label">Email *</label>
                    <input 
                      type="email" 
                      class="form-control"
                      [class.is-invalid]="campoEsInvalido('email')"
                      id="email"
                      formControlName="email"
                      placeholder="usuario@empresa.com">
                    <div class="invalid-feedback">
                      {{ obtenerMensajeError('email') }}
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="password" class="form-label">
                      Contraseña {{ editando ? '(dejar vacío para no cambiar)' : '*' }}
                    </label>
                    <input 
                      type="password" 
                      class="form-control"
                      [class.is-invalid]="campoEsInvalido('password')"
                      id="password"
                      formControlName="password"
                      placeholder="Mínimo 6 caracteres">
                    <div class="invalid-feedback">
                      {{ obtenerMensajeError('password') }}
                    </div>
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="rol" class="form-label">Rol *</label>
                    <select 
                      class="form-select"
                      [class.is-invalid]="campoEsInvalido('rol')"
                      id="rol"
                      formControlName="rol">
                      <option value="">Seleccione un rol</option>
                      <option *ngFor="let rol of roles" [value]="rol">{{ rol }}</option>
                    </select>
                    <div class="invalid-feedback">
                      {{ obtenerMensajeError('rol') }}
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="departamento" class="form-label">Departamento *</label>
                    <select 
                      class="form-select"
                      [class.is-invalid]="campoEsInvalido('departamento')"
                      id="departamento"
                      formControlName="departamento">
                      <option value="">Seleccione un departamento</option>
                      <option *ngFor="let depto of departamentos" [value]="depto">{{ depto }}</option>
                    </select>
                    <div class="invalid-feedback">
                      {{ obtenerMensajeError('departamento') }}
                    </div>
                  </div>
                </div>
                
                <div class="d-flex gap-2">
                  <button 
                    type="submit" 
                    class="btn btn-success"
                    [disabled]="!usuarioForm.valid || cargando">
                    <span class="spinner-border spinner-border-sm" *ngIf="cargando" aria-hidden="true"></span>
                    {{ editando ? 'Actualizar' : 'Crear' }} Usuario
                  </button>
                  <button 
                    type="button" 
                    class="btn btn-secondary"
                    (click)="cancelarFormulario()"
                    [disabled]="cargando">
                    Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Lista de usuarios -->
      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-center mb-3" *ngIf="cargando && !mostrarFormulario">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
          
          <div class="table-responsive" *ngIf="!cargando || usuarios.length > 0">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Rol</th>
                  <th>Departamento</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let usuario of usuarios">
                  <td>{{ usuario.id }}</td>
                  <td>{{ usuario.nombre }}</td>
                  <td>{{ usuario.email }}</td>
                  <td>
                    <span class="badge" 
                          [class]="usuario.rol === 'ADMIN' ? 'bg-danger' : 
                                   usuario.rol === 'INSTRUCTOR' ? 'bg-warning' : 'bg-info'">
                      {{ usuario.rol }}
                    </span>
                  </td>
                  <td>{{ usuario.departamento }}</td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button 
                        class="btn btn-outline-primary"
                        (click)="editarUsuario(usuario)"
                        [disabled]="cargando"
                        title="Editar">
                        Editar
                      </button>
                      <button 
                        class="btn btn-outline-danger"
                        (click)="eliminarUsuario(usuario)"
                        [disabled]="cargando"
                        title="Eliminar">
                        Eliminar
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            
            <div class="alert alert-info text-center" *ngIf="usuarios.length === 0 && !cargando">
              ℹ️ No se encontraron usuarios registrados.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>